<!-- Header -->
<div class="flex items-center justify-between p-4">
  <div class="flex items-center gap-3">
    <a routerLink="/user/profile/{{ post.author.profile.username }}">
      <app-avatar [avatarUrl]="post.author.profile.avatarUrl" [width]="40" [height]="40"
        [customClass]="'rounded-full object-cover'"></app-avatar>
    </a>

    <div>
      <a routerLink="/user/profile/{{ post.author.profile.username }}" class="hover:underline">
        <p class="font-semibold text-gray-900">
          {{ post.author.profile.fullName || post.author.profile.username }}
        </p>
      </a>
      <p class="text-xs text-gray-500">
        {{ post.createdAt | timeAgo}}
      </p>
    </div>
  </div>

  <div>
    <!-- Privacy chọn dropdown -->
    <div class="relative inline-block text-left">
      <button [disabled]="post.author.id !== currentUserLoggedIn?.id" (click)="togglePrivacyMenu(post.id)"
        class="flex items-center gap-2 text-gray-500">
        <i class="fas" [ngClass]="getPrivacyIcon(post.privacy)"></i>
      </button>

      <!-- Overlay để bắt sự kiện click ra ngoài -->
      <div *ngIf="post.author.id === currentUserLoggedIn?.id && isPrivacyMenuOpen(post.id)" class="fixed inset-0 z-40"
        (click)="closePrivacyMenu()"></div>

      <!-- Dropdown menu -->
      @if (post.author.id === currentUserLoggedIn?.id && isPrivacyMenuOpen(post.id)) {
      <div class="absolute mt-2 w-48 bg-white shadow-lg rounded-md border z-50">
        <ul class="py-1 text-sm text-gray-700">
          <li (click)="updatePrivacyPost(post.id, 'PUBLIC')"
            class="px-4 py-2 hover:bg-gray-100 flex items-center gap-2 cursor-pointer">
            <i class="fas fa-globe text-blue-500"></i> Công khai
          </li>
          <li (click)="updatePrivacyPost(post.id, 'FRIENDS')"
            class="px-4 py-2 hover:bg-gray-100 flex items-center gap-2 cursor-pointer">
            <i class="fas fa-user-friends text-green-500"></i> Bạn bè
          </li>
          <li (click)="updatePrivacyPost(post.id, 'ONLY_ME')"
            class="px-4 py-2 hover:bg-gray-100 flex items-center gap-2 cursor-pointer">
            <i class="fas fa-lock text-gray-700"></i> Chỉ mình tôi
          </li>
          <li (click)="updatePrivacyPost(post.id, 'CUSTOM')"
            class="px-4 py-2 hover:bg-gray-100 flex items-center gap-2 cursor-pointer">
            <i class="fas fa-cog text-purple-500"></i> Tuỳ chỉnh
          </li>
        </ul>
      </div>
      }
    </div>

    <!-- Nút ba gạch (menu cho post) nằm ngoài rìa phải -->
    @if (post.author.id === currentUserLoggedIn?.id){
    <div class="relative inline-block text-left ml-auto">
      <button (click)="togglePostMenu(post.id)" class="p-2 text-gray-500 hover:text-gray-700">
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <!-- Overlay để bắt sự kiện click ra ngoài -->
      <div *ngIf="isPostMenuOpen(post.id)" class="fixed inset-0 z-40" (click)="closePostMenu()"></div>

      <!-- Dropdown menu -->
      <div *ngIf="isPostMenuOpen(post.id)" class="absolute right-0 mt-2 w-40 bg-white shadow-lg rounded-md border z-50">
        <ul class="py-1 text-sm text-gray-700">
          <li (click)="deletePost(post.id)" class="px-4 py-2 hover:bg-red-100 text-red-600 cursor-pointer">
            <i class="fas fa-trash"></i> Xóa
          </li>
          <li (click)="toggleCommentBlock(post)" class="px-4 py-2 hover:bg-gray-100 cursor-pointer">
            <i class="fas" [ngClass]="post.commentLocked ? 'fa-unlock' : 'fa-lock'"></i>
            {{ post.commentLocked ? 'Mở khóa bình luận' : 'Khóa bình luận' }}
          </li>
        </ul>
      </div>
    </div>
    }
  </div>
</div>

<!-- Nội dung -->
@if (post.content && post.content.trim() != '') {
<div class="px-4 pb-2">
  <p class="text-gray-800">{{ post.content }}</p>
</div>
}

<!-- Media -->
<div class="w-full px-4" *ngIf="post.mediaList && post.mediaList.length > 0">
  <div *ngFor="let media of post.mediaList" class="mb-2">
    <img *ngIf="media.mediaType === 'image'" [src]="media.url" class="w-full h-96 object-cover rounded-lg" />
    <video *ngIf="media.mediaType === 'video'" controls class="w-full h-auto rounded-lg">
      <source [src]="media.url" type="video/mp4" />
    </video>
  </div>
</div>

<!-- Action buttons -->
<div class="flex justify-around items-center text-gray-500 border-t mt-3 text-sm">
  <!-- Like -->
  <app-like [post]="post"></app-like>
  <!-- Comment -->
  <button (click)="toggleComment()" class="flex items-center gap-1 py-2">
    <i class="fas fa-comment"></i>
    {{ totalComments }} Comment
  </button>
  <!-- Share -->
  <button class="flex items-center gap-1 py-2 hover:text-purple-500">
    <i class="fas fa-share"></i> Share
  </button>
</div>

@if (post.commentLocked) {
  <div *ngIf="post.commentLocked" class="text-center text-red-500 text-sm pb-2 mt-2 font-semibold">
    Bài viết đã bị khóa bình luận
  </div>
}
<!-- Comments section -->
@if (showCommentBox) {
  <div class="mt-3 border-t p-2">
    <app-comment 
      [post]="post" 
      [currentUser]="currentUserLoggedIn"
      [commentLocked]="post.commentLocked"
      [highlightCommentId]="highlightCommentId"
      (addCommentEvent)="totalComments = totalComments! + 1"
    ></app-comment>
  </div>
} 